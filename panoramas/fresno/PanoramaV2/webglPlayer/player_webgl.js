var nvgMd=1;var ptsPlCr=false;var vgntVsbl=false;var camera,scene,rdr2D,rdr3D,cnv2D,cnv3D,ctx2d;var texture_placeholder,isUserInteracting=false,isUserMoving=false,onMouseDownMouseX=0,onMouseDownMouseY=0,lon=0,onMouseDownLon=0,lat=0,onMouseDownLat=0,phi=0,theta=0;var oldtheta=0,theta2=0;var mousex=0,mousey=0;var INTERSECTED;var projector;var geometrySphere=new THREE.SphereGeometry(2,8,6,true);var materialSphere=new THREE.MeshBasicMaterial({color:16711680,wireframe:false});var mtrlPno,materials;var mesh;init();animate();function crPtsClck(){var o,n,h;var m;for(var g=0;g<tbTR.length;g++){if(tbTR[g][0]==idCrt){for(var e=1;e<tbTR[g].length;e++){for(var d=0;d<tbCP.length;d+=nbElmPrNd){if(tbCP[d]==tbTR[g][e]){o=tbCP[d+1]*1000;n=tbCP[d+2]*1000;h=tbCP[d+3]*1000;m=camera.position.clone();var p=new THREE.Vector3(-(o-cdxCrt*1000),h-cdzCrt*1000,n-cdyCrt*1000);var l=m.clone().subSelf(p);var b=new THREE.Ray(p,l.clone().normalize());var f=b.intersectObject(mesh);var c;if(f.length>0){var a=new THREE.Mesh(geometrySphere,materialSphere);a.position.x=f[0].point.x;a.position.y=f[0].point.y;a.position.z=f[0].point.z;c=new THREE.Vector3(a.position.x,a.position.y,a.position.z).normalize();tbCP[d+4]=a.position.x=a.position.x-10*c.x;tbCP[d+5]=a.position.y=a.position.y-10*c.y;tbCP[d+6]=a.position.z=a.position.z-10*c.z;a.name=tbCP[d+7];a.visible=false;scene.add(a)}}}}}}}function efPtsClck(){ctx2d.clearRect(0,0,window.innerWidth,window.innerHeight);for(var b=0;b<tbCP.length;b+=nbElmPrNd){if(tbCP[b]!=idCrt){for(var a=0;a<scene.children.length;a++){var c=scene.children[a];if(c.position.x==tbCP[b+4]&&c.position.y==tbCP[b+5]&&c.position.z==tbCP[b+6]){scene.remove(c)}}}}}function crVgnt(){var c=document.getElementById("vgnts");c.style.width=(document.getElementById("ctnVgt").offsetWidth-44)+"px";var a=dsrPano+igFt;for(var b=0;b<tbCP.length;b+=nbElmPrNd){if(tbCP[b]==idCrt){document.getElementById("nmVgt").appendChild(document.createTextNode(tbCP[b+7]))}var d=document.createElement("img");d.id=tbCP[b];d.src=a+tbCP[b]+".jpg";d.title=tbCP[b+7];d.alt="Vignette "+b;d.height=d.width=70;d.align="MIDDLE";d.hspace=d.vspace=10;if(d.id==idCrt){d.style.border="2px solid red"}else{d.style.border="2px solid black"}d.style.cursor="pointer";c.appendChild(d);document.getElementById(d.id).onclick=function(){efPtsClck();for(var f=0;f<tbCP.length;f+=nbElmPrNd){if(tbCP[f]==this.id){document.getElementById(idCrt).style.border="2px solid black";var g=idCrt;idCrt=tbCP[f];document.getElementById(idCrt).style.border="2px solid red";if(plExt==true&&ptsPlCr==true){document.getElementById(nmPlAfCrt).style.border="2px solid black";document.getElementById(nmPlCrt).style.border="2px solid black";if(tbCP[f+8]!="noplanforthisnode"){nmPlAfCrt=nmPlCrt=tbCP[f+8];document.getElementById("nmVgtPl").firstChild.nodeValue=nmPlCrt.substring(0,nmPlCrt.indexOf(".",0))}}cdxCrt=tbCP[f+1];cdyCrt=tbCP[f+2];cdzCrt=tbCP[f+3];nmIdCrt=tbCP[f+7];anHCrt=tbCP[f+9];anVCrt=tbCP[f+10];for(var e=0;e<materials.length;e++){rdr3D.deallocateTexture(materials[e].map);rdr3D.deallocateTexture(materials[e]);materials[e].deallocate();materials[e].map.deallocate()}materials=[ldTxt(dsrPano+igRt+idCrt+".jpg"),ldTxt(dsrPano+igLt+idCrt+".jpg"),ldTxt(dsrPano+igUp+idCrt+".jpg"),ldTxt(dsrPano+igDn+idCrt+".jpg"),ldTxt(dsrPano+igFt+idCrt+".jpg"),ldTxt(dsrPano+igBk+idCrt+".jpg")];mtrlPno.materials=materials;crPtsClck();initC();camera.updateProjectionMatrix()}}};document.getElementById(d.id).onmouseover=function(){document.getElementById("nmVgt").firstChild.nodeValue=this.title;this.style.border="2px solid blue"};document.getElementById(d.id).onmouseout=function(){document.getElementById("nmVgt").firstChild.nodeValue=nmIdCrt;if(this.id==idCrt){this.style.border="2px solid red"}else{this.style.border="2px solid black"}}}}var myInterval=null;function mvThbLC(){var a=document.getElementById("vgnts");a.scrollLeft+=-75}function mvThbL(){myInterval=setInterval(function(){var a=document.getElementById("vgnts");a.scrollLeft+=-75},300)}function mvThbRC(){var a=document.getElementById("vgnts");a.scrollLeft+=75}function mvThbR(){myInterval=setInterval(function(){var a=document.getElementById("vgnts");a.scrollLeft+=75},300)}function stpMvThb(){clearInterval(myInterval)}function crPl(){var k=dsrPano+"special/";var e=document.getElementById("imgPlanCourant");var b=document.getElementById("vgtPl");var g=-1;var n=false;for(var r=0;r<tbPln.length;r+=8){for(var s=0;s<tbCP.length;s+=nbElmPrNd){var f=1000000000;var u=tbCP[s];var l=tbCP[s+3];for(var v=0;v<tbPln.length;v+=8){var o=tbCP[s+1];var m=tbCP[s+2];var h=-tbPln[v+7]*Math.PI/180;var q=tbPln[v+1]+(tbPln[v+4]-tbPln[v+1])/2;var p=-(tbPln[v+2]+(tbPln[v+5]-tbPln[v+2])/2);o-=p;m-=q;var d=o*Math.cos(h)-m*Math.sin(h);var c=o*Math.sin(h)+m*Math.cos(h);d+=p;c+=q;o=c;m=-d;var a=(tbPln[v+2]<=tbPln[v+5])?(tbPln[v+2]<=m&&m<=tbPln[v+5]):(tbPln[v+5]<=m&&m<=tbPln[v+2]);a=a&&(tbPln[v+1]<=o&&o<=tbPln[v+4])&&(tbPln[v+6]<=l&&l<=tbPln[v+3])&&(tbPln[v+3]<=f);if(a==true){tbCP[s+8]=tbPln[v];ptsPlCr=true;if(tbCP[s]==idCrt&&n==false){document.getElementById("nmVgtPl").appendChild(document.createTextNode((tbCP[s+8]).substring(0,(tbCP[s+8]).indexOf(".",0))));nmPlCrt=nmPlAfCrt=tbPln[v];g=v;e.src=k+nmPlCrt;n=true}f=tbPln[v+3]}}if(tbCP[s+8]=="noplanforthisnode"){if(tbCP[s]==idCrt&&n==false){nmPlCrt=nmPlAfCrt=tbPln[0];if(!document.getElementById("nmVgtPl").firstChild){document.getElementById("nmVgtPl").appendChild(document.createTextNode((tbPln[0]).substring(0,(tbPln[0]).indexOf(".",0))))}g=0;e.src=k+nmPlCrt;n=true}}}if(ptsPlCr==true&&g!=-1){crPtPl(tbPln[g]);g=-1}else{e.src=k+tbPln[0]}var t=document.createElement("img");t.id=tbPln[r];t.src=k+tbPln[r];t.alt=tbPln[r];t.height=t.width=70;t.align="MIDDLE";t.hspace=t.vspace=10;if(t.id==nmPlCrt){t.style.border="2px solid red"}else{t.style.border="2px solid black"}t.style.cursor="pointer";b.appendChild(t);document.getElementById(t.id).onclick=function(){vigP=document.getElementById("imgPlanCourant");vigP.src=this.src;if(nmPlAfCrt==nmPlCrt){document.getElementById(nmPlAfCrt).style.border="2px solid red"}else{document.getElementById(nmPlAfCrt).style.border="2px solid black"}nmPlAfCrt=this.id;if(nmPlAfCrt==nmPlCrt){document.getElementById(nmPlAfCrt).style.border="2px solid red"}else{document.getElementById(nmPlAfCrt).style.border="2px solid purple"}if(ptsPlCr==true){spmPtPl();crPtPl(this.id)}};document.getElementById(t.id).onmouseover=function(){document.getElementById("nmVgtPl").firstChild.nodeValue=(this.id).substring(0,(this.id).indexOf(".",0));this.style.border="2px solid blue"};document.getElementById(t.id).onmouseout=function(){document.getElementById("nmVgtPl").firstChild.nodeValue=nmPlAfCrt.substring(0,nmPlAfCrt.indexOf(".",0));if(this.id==nmPlAfCrt){this.style.border="2px solid purple"}else{this.style.border="2px solid black"}if(this.id==nmPlCrt){this.style.border="2px solid red"}}}}function crPtPl(m){var r=-1;var y,x,p,o,g,p,o,w,u;for(var q=0;q<tbPln.length;q+=8){if(tbPln[q]==m){r=q;y=tbPln[q+1]-tbPln[q+4];x=tbPln[q+2]-tbPln[q+5];g=-tbPln[q+7]*Math.PI/180;p=tbPln[q+1]+(tbPln[q+4]-tbPln[q+1])/2;o=-(tbPln[q+2]+(tbPln[q+5]-tbPln[q+2])/2);w=tbPln[q+1];u=tbPln[q+2];break}}var v=document.getElementById("lePlan");var d=v.offsetWidth;var l=v.offsetHeight;var k,s,c,n,j,z;var e=Math.min(tbPln[r+1],tbPln[r+4]);var f=(e==tbPln[r+1])?(-tbPln[r+2]):(-tbPln[r+5]);var v=document.getElementById("lePlan");for(var q=0;q<tbCP.length;q+=nbElmPrNd){if(tbCP[q+8]==m){k=tbCP[q+1];s=tbCP[q+2];k-=o;s-=p;var b=k*Math.cos(g)-s*Math.sin(g);var a=k*Math.sin(g)+s*Math.cos(g);b+=o;a+=p;k=a;s=-b;j=Math.abs(k-w)*d/Math.abs(y);z=Math.abs(s-u)*l/Math.abs(x);n=(j-5.5)*100/d;c=100-(z+6.5)*100/l;var h=document.createElement("div");h.id="pointMap_"+tbCP[q];h.style.position="absolute";h.style.top=c+"%";h.style.left=n+"%";h.style.background="rgba(100,100,100,0.5)";h.style.color="white";h.style.cursor="pointer";var t=document.createElement("img");t.id="img_pointMap_"+tbCP[q];if(tbCP[q]==idCrt){t.src="./webglPlayer/pointDuPlan2.png"}else{t.src="./webglPlayer/pointDuPlan.png"}t.title=tbCP[q+7];t.alt=tbCP[q+7];t.height=t.width=15;h.appendChild(t);h.appendChild(document.createTextNode(" "+tbCP[q+7]));v.appendChild(h);document.getElementById(h.id).onclick=function(){efPtsClck();for(var A=0;A<tbCP.length;A+=nbElmPrNd){var B=(this.id).substring(9,(this.id).length);if(tbCP[A]==B){document.getElementById(idCrt).style.border="2px solid black";var C=idCrt;idCrt=tbCP[A];document.getElementById(idCrt).style.border="2px solid red";if(plExt==true&&ptsPlCr==true){document.getElementById(nmPlCrt).style.border="2px solid black";nmPlCrt=tbCP[A+8]}cdxCrt=tbCP[A+1];cdyCrt=tbCP[A+2];cdzCrt=tbCP[A+3];nmIdCrt=tbCP[A+7];anHCrt=tbCP[A+9];anVCrt=tbCP[A+10];for(var i=0;i<materials.length;i++){rdr3D.deallocateTexture(materials[i].map);rdr3D.deallocateTexture(materials[i]);materials[i].deallocate();materials[i].map.deallocate()}materials=[ldTxt(dsrPano+igRt+idCrt+".jpg"),ldTxt(dsrPano+igLt+idCrt+".jpg"),ldTxt(dsrPano+igUp+idCrt+".jpg"),ldTxt(dsrPano+igDn+idCrt+".jpg"),ldTxt(dsrPano+igFt+idCrt+".jpg"),ldTxt(dsrPano+igBk+idCrt+".jpg")];mtrlPno.materials=materials;crPtsClck();initC();camera.updateProjectionMatrix()}}afPl()};document.getElementById(h.id).onmouseover=function(){this.style.background="rgba(0,0,255,0.5)"};document.getElementById(h.id).onmouseout=function(){this.style.background="rgba(100,100,100,0.5)"}}}}function spmPtPl(){var b=document.getElementById("lePlan");for(var a=0;a<tbCP.length;a+=nbElmPrNd){if(document.getElementById("pointMap_"+tbCP[a])){b.removeChild(document.getElementById("pointMap_"+tbCP[a]))}}}var planVisible=false;function afPl(){if(plExt==true){var f=document.getElementById("fntPl");if(f.style.visibility=="hidden"){if(document.getElementById(nmPlCrt)){document.getElementById(nmPlCrt).click()}document.getElementById("boutonPlan2D").src="./webglPlayer/plan2.png";document.getElementById("vgtPl").style.overflow="auto";var b=document.getElementById("vgtPl").offsetHeight;var a=document.getElementById("fntPl").offsetHeight;var c=document.getElementById("fntPl").offsetWidth;var e=a-b-50;document.getElementById("lePlan").style.height=e+"px";document.getElementById("nmVgtPl").style.top=(e+10)+"px";document.getElementById("nmVgtPl").style.left=(38*3)+"px";document.getElementById("lePlan").style.width=(c-(38*6))+"px";document.getElementById("lePlan").style.left=(38*3)+"px";document.getElementById("lftAr").style.marginTop=(e/2-38/2)+"px";document.getElementById("lftAr").style.marginLeft=(38*2)+"px";document.getElementById("rgtAr").style.marginTop=(e/2-38/2)+"px";document.getElementById("rgtAr").style.marginRight=(38*2-10)+"px";f.style.visibility="visible";for(var d=0;d<tbPln.length;d+=8){if(d==0||d%8==0){if(tbPln[d]==nmPlCrt){if(d-8<0){document.getElementById("lftAr").style.visibility="hidden"}else{document.getElementById("lftAr").style.visibility="visible"}if(d+8>=tbPln.length){document.getElementById("rgtAr").style.visibility="hidden"}else{document.getElementById("rgtAr").style.visibility="visible"}break}}}planVisible=true}else{document.getElementById("boutonPlan2D").src="./webglPlayer/plan.png";f.style.visibility="hidden";document.getElementById("lftAr").style.visibility="hidden";document.getElementById("rgtAr").style.visibility="hidden";document.getElementById("vgtPl").style.overflow="hidden";planVisible=false}}}function prPl(){for(var b=0;b<tbPln.length;b+=8){if(b==0||b%8==0){if(tbPln[b]==nmPlAfCrt){var a=b-8;if(a>=0){document.getElementById("rgtAr").style.visibility="visible";if(a-8<0){document.getElementById("lftAr").style.visibility="hidden"}if(document.getElementById(tbPln[a])){document.getElementById(tbPln[a]).click();document.getElementById("nmVgtPl").firstChild.nodeValue=nmPlAfCrt.substring(0,nmPlAfCrt.indexOf(".",0))}break}}}}}function nePl(){for(var b=0;b<tbPln.length;b+=8){if(b==0||b%8==0){if(tbPln[b]==nmPlAfCrt){var a=b+8;if(a<tbPln.length){document.getElementById("lftAr").style.visibility="visible";if(a+8>=tbPln.length){document.getElementById("rgtAr").style.visibility="hidden"}if(document.getElementById(tbPln[a])){document.getElementById(tbPln[a]).click();document.getElementById("nmVgtPl").firstChild.nodeValue=nmPlAfCrt.substring(0,nmPlAfCrt.indexOf(".",0))}break}}}}}function init(){if(!Detector.webgl){window.location.replace("./webglPlayer/help.html")}cnv2D=document.getElementById("cnv2D");try{rdr2D=new THREE.CanvasRenderer({canvas:cnv2D});rdr2D.setSize(window.innerWidth,window.innerHeight)}catch(b){window.location.replace("./webglPlayer/help.html")}if(plExt==false){document.getElementById("boutonPlan2D").style.visibility="hidden"}cnv3D=document.getElementById("cnv3D");rdr3D=new THREE.WebGLRenderer({canvas:cnv3D});rdr3D.setSize(window.innerWidth,window.innerHeight);ctx2d=rdr2D.domElement.getContext("2d");ctx2d.clearRect(0,0,window.innerWidth,window.innerHeight);ctx2d.font="18px 'Times New Roman', Times, serif";camera=new THREE.PerspectiveCamera(fov,window.innerWidth/window.innerHeight,1,300);camera.target=new THREE.Vector3(0,0,0);scene=new THREE.Scene();texture_placeholder=document.createElement("canvas");texture_placeholder.width=128;texture_placeholder.height=128;var a=texture_placeholder.getContext("2d");a.fillStyle="rgb( 200, 200, 200 )";a.fillRect(0,0,texture_placeholder.width,texture_placeholder.height);materials=[ldTxt(dsrPano+igRt+idCrt+".jpg"),ldTxt(dsrPano+igLt+idCrt+".jpg"),ldTxt(dsrPano+igUp+idCrt+".jpg"),ldTxt(dsrPano+igDn+idCrt+".jpg"),ldTxt(dsrPano+igFt+idCrt+".jpg"),ldTxt(dsrPano+igBk+idCrt+".jpg")];mtrlPno=new THREE.MeshFaceMaterial(materials);mtrlPno.needsUpdate=true;mesh=new THREE.Mesh(new THREE.CubeGeometry(256,256,256,7,7,7),mtrlPno);mesh.scale.x=-1;scene.add(mesh);initC();projector=new THREE.Projector();if(tbTR.length>0){crPtsClck()}if(plExt==true){crPl()}crVgnt();document.addEventListener("mousedown",onDocumentMouseDown,false);document.addEventListener("mousemove",onDocumentMouseMove,false);document.addEventListener("mouseup",onDocumentMouseUp,false);document.addEventListener("dblclick",onDoubleClick,false);document.addEventListener("mousewheel",onDocumentMouseWheel,false);document.addEventListener("DOMMouseScroll",onDocumentMouseWheel,false);window.addEventListener("resize",onWindowResize,false)}function initC(){camera.fov=fov=orgFov;onMouseDownMouseX=0;onMouseDownMouseY=0;lon=90;lat=0;if(version5==true){lon=(anHCrt-180)<=0?(180-anHCrt):(540-anHCrt);lat=(90-anVCrt);var a=new THREE.Matrix4();var c=new THREE.Matrix4();var b=new THREE.Matrix4();var e=-(90-anVCrt)*Math.PI/180;var d=-(90-anHCrt)*Math.PI/180;c.makeRotationX(e);b.makeRotationY(d);a.multiply(b,c);mesh.rotation.setEulerFromRotationMatrix(a)}onMouseDownLon=0;onMouseDownLat=0;phi=0;theta=0;oldtheta=0;theta2=0}function initCamera2(){camera.fov=fov=orgFov;onMouseDownMouseX=0;onMouseDownMouseY=0;if(version5==true){var a=new THREE.Matrix4();var c=new THREE.Matrix4();var b=new THREE.Matrix4();var e=-(90-anVCrt)*Math.PI/180;var d=-(90-anHCrt)*Math.PI/180;c.makeRotationX(e);b.makeRotationY(d);a.multiply(b,c);mesh.rotation.setEulerFromRotationMatrix(a)}onMouseDownLon=0;onMouseDownLat=0;oldtheta=0;theta2=0}function chNvMd(){if(nvgMd==1){document.getElementById("boutonModeNavigation").src="./webglPlayer/navigationVignette2.png";nvgMd=2}else{if(nvgMd==2){document.getElementById("boutonModeNavigation").src="./webglPlayer/navigationVignette1.png";nvgMd=1}}}function toScreenXY(a,d,b){var e=a.clone();var c=new THREE.Matrix4();c.multiply(d.projectionMatrix,d.matrixWorldInverse);c.multiplyVector3(e);return{x:(e.x+1)*b.width/2+b.offsetLeft,y:(-e.y+1)*b.height/2+b.offsetTop}}function ldTxt(d){var b=new THREE.Texture(texture_placeholder);var a=new THREE.MeshBasicMaterial({map:b,overdraw:true});var c=new Image();c.onload=function(){b.needsUpdate=true;a.map.image=this;render()};c.src=d;b.deallocate();rdr3D.deallocateTexture(b);return a}var inFullScreen=false;function cancelFS(a){inFullScreen=false;var c=a.cancelFullScreen||a.webkitCancelFullScreen||a.mozCancelFullScreen||a.exitFullscreen||a.msExitFullscreen;if(c){c.call(a)}else{if(a.msExitFullscreen()){a.msExitFullscreen()}else{if(typeof window.ActiveXObject!=="undefined"){var b=new ActiveXObject("WScript.Shell");if(b!==null){b.SendKeys("{F11}")}}}}inFullScreen=false}function requestFS(a){inFullScreen=true;var c=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullScreen||a.requestFullscreen||a.webkitRequestFullscreen||a.mozRequestFullscreen||a.msRequestFullscreen;if(c){c.call(a);a.mozrequestFS()}else{if(typeof window.ActiveXObject!=="undefined"){var b=new ActiveXObject("WScript.Shell");b.SendKeys("{F11}");if(b!==null){b.SendKeys("{F11}")}}else{if(a.requestFullscreen){a.requestFS()}else{if(a.msRequestFullscreen){a.msrequestFS()}else{if(a.mozRequestFullScreen){a.mozrequestFS()}else{if(a.webkitRequestFullscreen){a.webkitrequestFS()}}}}}}inFullScreen=true}function toggleF(){var b=document.body;var a=(document.fullScreenElement&&document.fullScreenElement!==null)||(document.mozFullScreen||document.webkitIsFullScreen);if(a||inFullScreen==true){cancelFS(document)}else{if(a==false||inFullScreen==false){requestFS(b)}}return false}function onWindowResize(){var d=document.getElementById("vgnts");d.style.width=(document.getElementById("ctnVgt").offsetWidth-44)+"px";if(planVisible==false&&vgntVsbl==true){var f=document.getElementById("vgnts").offsetHeight;document.getElementById("nmVgt").style.bottom=f+"px";document.getElementById("ctnVgt").style.top=(window.innerHeight-f)+"px"}else{var b=document.getElementById("vgtPl").offsetHeight;var a=document.getElementById("fntPl").offsetHeight;var c=document.getElementById("fntPl").offsetWidth;var e=a-b-50;document.getElementById("lePlan").style.height=e+"px";document.getElementById("nmVgtPl").style.top=(e+10)+"px";document.getElementById("nmVgtPl").style.left=(38*3)+"px";document.getElementById("lePlan").style.width=(c-(38*6))+"px";document.getElementById("lePlan").style.left=(38*3)+"px";document.getElementById("lftAr").style.marginTop=(e/2-38/2)+"px";document.getElementById("lftAr").style.marginLeft=(38*2)+"px";document.getElementById("rgtAr").style.marginTop=(e/2-38/2)+"px";document.getElementById("rgtAr").style.marginRight=(38*2-10)+"px"}camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();rdr2D.setSize(window.innerWidth,window.innerHeight);rdr3D.setSize(window.innerWidth,window.innerHeight);camera.projectionMatrix.makePerspective(fov,window.innerWidth/window.innerHeight,1,300);ctx2d.font="18px 'Times New Roman', Times, serif"}function onDocumentMouseDown(b){if(planVisible==false){var a=document.getElementById("vgnts").offsetHeight;if(b.clientY<(window.innerHeight-a)){b.preventDefault();isUserInteracting=true;mousex=(b.clientX/window.innerWidth)*2-1;mousey=-(b.clientY/window.innerHeight)*2+1;onPointerDownPointerX=b.clientX;onPointerDownPointerY=b.clientY;onPointerDownLon=lon;onPointerDownLat=lat}}}var intervalMvThumbs=null;var newPos=0;var timeMoveTh;var timeLaunch=false;var timeLaunchToBottom=false;function mvThb(b){var c=document.getElementById("ctnVgt");var a=document.getElementById("vgnts").offsetHeight;if(b==1){if(newPos<=a){c.style.top=(window.innerHeight-newPos)+"px";document.getElementById("nmVgt").style.bottom=newPos+"px";if(newPos<=a){newPos+=2}}else{clearInterval(intervalMvThumbs)}}else{if(b==-1){if(newPos>=0){c.style.top=(window.innerHeight-newPos)+"px";document.getElementById("nmVgt").style.bottom=newPos+"px";if(newPos>0){newPos-=2}}else{clearInterval(intervalMvThumbs)}}}}function onDocumentMouseMove(f){document.getElementById("cnv2D").style.cursor="auto";if(planVisible==false){document.getElementById("lblVgt").style.visibility="hidden";if(isUserInteracting){document.getElementById("cnv2D").style.cursor="move";isUserMoving=true;lon=-(onPointerDownPointerX-f.clientX)*0.1+onPointerDownLon;lat=-(f.clientY-onPointerDownPointerY)*0.3+onPointerDownLat;render()}if(isUserInteracting==false){var d=document.getElementById("vgnts").offsetHeight;if(f.clientY>(window.innerHeight-d)){document.getElementById("ctnVgt").style.visibility="visible";document.getElementById("vgnts").style.visibility="visible";if(timeLaunchToBottom==true){timeLaunchToBottom=false;timeLaunch=false;clearInterval(intervalMvThumbs);intervalMvThumbs=null}if(timeLaunch==false){intervalMvThumbs=setInterval("mvThb(1)",1);timeLaunch=true}vgntVsbl=true}else{if(timeLaunch==true){timeLaunchToBottom=false;timeLaunch=false;clearInterval(intervalMvThumbs);intervalMvThumbs=null}if(timeLaunchToBottom==false){intervalMvThumbs=setInterval("mvThb(-1)",1);timeLaunchToBottom=true}vgntVsbl=false;document.getElementById("nmVgt").firstChild.nodeValue=nmIdCrt;mousex=(f.clientX/window.innerWidth)*2-1;mousey=-(f.clientY/window.innerHeight)*2+1;var b=new THREE.Vector3(mousex,mousey,0.5);projector.unprojectVector(b,camera);var a=new THREE.Ray(camera.position,b.subSelf(camera.position).normalize());var e=a.intersectObjects(scene.children);if(e.length>0&&tbTR.length>0){for(var c=0;c<tbCP.length;c+=nbElmPrNd){if(e[0].object.position.x==tbCP[c+4]&&e[0].object.position.y==tbCP[c+5]&&e[0].object.position.z==tbCP[c+6]){document.getElementById("cnv2D").style.cursor="pointer";document.getElementById("lblVgt").style.top=f.clientY+"px";document.getElementById("lblVgt").style.left=f.clientX+"px";document.getElementById("lblVgt").firstChild.nodeValue=tbCP[c+7];document.getElementById("lblVgt").style.visibility="visible";document.getElementById("nmVgt").firstChild.nodeValue=tbCP[c+7];break}}}}}}}function onDocumentMouseUp(f){if(planVisible==false){isUserInteracting=false;isUserMoving=false;oldtheta=theta=theta2;lon=theta*180/Math.PI;var b=new THREE.Vector3(mousex,mousey,0.5);projector.unprojectVector(b,camera);var a=new THREE.Ray(camera.position,b.subSelf(camera.position).normalize());var e=a.intersectObjects(scene.children);if(e.length>0&&tbTR.length>0){for(var d=0;d<tbCP.length;d+=nbElmPrNd){if(e[0].object.position.x==tbCP[d+4]&&e[0].object.position.y==tbCP[d+5]&&e[0].object.position.z==tbCP[d+6]){document.getElementById(idCrt).style.border="2px solid black";efPtsClck();var g=idCrt;idCrt=tbCP[d];document.getElementById(idCrt).style.border="2px solid red";cdxCrt=tbCP[d+1];cdyCrt=tbCP[d+2];cdzCrt=tbCP[d+3];nmIdCrt=tbCP[d+7];anHCrt=tbCP[d+9];anVCrt=tbCP[d+10];document.getElementById("nmVgt").firstChild.nodeValue=nmIdCrt;document.getElementById("lblVgt").style.visibility="hidden";if(plExt==true&&ptsPlCr==true){document.getElementById(nmPlAfCrt).style.border="2px solid black";document.getElementById(nmPlCrt).style.border="2px solid black";if(tbCP[d+8]!="noplanforthisnode"){nmPlAfCrt=nmPlCrt=tbCP[d+8];document.getElementById("nmVgtPl").firstChild.nodeValue=nmPlCrt.substring(0,nmPlCrt.indexOf(".",0))}}for(var c=0;c<materials.length;c++){rdr3D.deallocateTexture(materials[c].map);rdr3D.deallocateTexture(materials[c]);materials[c].deallocate();materials[c].map.deallocate()}materials=[ldTxt(dsrPano+igRt+idCrt+".jpg"),ldTxt(dsrPano+igLt+idCrt+".jpg"),ldTxt(dsrPano+igUp+idCrt+".jpg"),ldTxt(dsrPano+igDn+idCrt+".jpg"),ldTxt(dsrPano+igFt+idCrt+".jpg"),ldTxt(dsrPano+igBk+idCrt+".jpg")];mtrlPno.materials=materials;if(nvgMd==1){initC()}else{if(nvgMd==2){initCamera2()}}camera.projectionMatrix.makePerspective(fov,window.innerWidth/window.innerHeight,1,300);crPtsClck()}}}}}function onDoubleClick(){if(planVisible==false){var a=document.getElementById("vgnts").offsetHeight;if(event.clientY<(window.innerHeight-a)){ctx2d.clearRect(0,0,window.innerWidth,window.innerHeight);camera.fov=fov=orgFov;camera.updateProjectionMatrix();render()}}}function onDocumentMouseWheel(b){if(planVisible==false){var a=document.getElementById("vgnts").offsetHeight;if(b.clientY<(window.innerHeight-a)){ctx2d.clearRect(0,0,window.innerWidth,window.innerHeight);if(b.wheelDeltaY){fov-=b.wheelDeltaY*0.05}else{if(b.wheelDelta){fov-=b.wheelDelta*0.05}else{if(b.detail){fov+=b.detail*1}}}if(fov>120){fov=120}if(fov<50){fov=50}camera.projectionMatrix.makePerspective(fov,window.innerWidth/window.innerHeight,1,300);render()}}}function animate(){requestAnimationFrame(animate);render()}function render(){if(isUserInteracting&&isUserMoving){lat=Math.max(-85,Math.min(85,lat));phi=(90-lat)*Math.PI/180;theta=lon*Math.PI/180;if(theta!=oldtheta){var g=Math.abs(theta-oldtheta)/(theta-oldtheta);var h=Math.abs(theta-oldtheta)*g;theta2+=h*Math.PI/50;if(theta2>=oldtheta+2*Math.PI){theta2=oldtheta}}camera.target.x=500*Math.sin(phi)*Math.cos(theta2);camera.target.y=500*Math.cos(phi);camera.target.z=500*Math.sin(phi)*Math.sin(theta2);camera.lookAt(camera.target)}else{lat=Math.max(-85,Math.min(85,lat));phi=(90-lat)*Math.PI/180;theta=lon*Math.PI/180;oldtheta=theta2=theta;camera.target.x=500*Math.sin(phi)*Math.cos(theta);camera.target.y=500*Math.cos(phi);camera.target.z=500*Math.sin(phi)*Math.sin(theta);camera.lookAt(camera.target)}if(tbTR.length>0){ctx2d.clearRect(0,0,window.innerWidth,window.innerHeight);for(var c=0;c<scene.children.length;c++){var i=new THREE.Frustum;i.setFromMatrix(new THREE.Matrix4().multiply(camera.projectionMatrix,camera.matrixWorldInverse));if(i.contains(scene.children[c])){var d=toScreenXY(scene.children[c].position,camera,cnv3D);if(0<=d.x&&d.x<=window.innerWidth&&0<=d.y&&d.y<=window.innerHeight){var a=scene.children[c].name;if(a){var f=ctx2d.measureText(a);var e=f.width;ctx2d.fillStyle="rgba(100,100,100,0.5)";ctx2d.fillRect(d.x+6,d.y-8,e,18);ctx2d.fillStyle="#ffffff";ctx2d.fillText(a,d.x+6,d.y+6);var b=new Image();b.src="./webglPlayer/pointDuPlan.png";ctx2d.drawImage(b,d.x-6,d.y-5)}}}}}rdr3D.render(scene,camera)};